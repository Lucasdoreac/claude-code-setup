#!/bin/bash
# security-update - AtualizaÃ§Ã£o diÃ¡ria de seguranÃ§a
# Atualiza todos os gerenciadores de pacotes automaticamente
# Criado: 2025-11-08

set -e

LOG_FILE="$HOME/.update-logs/security-update-$(date +%Y%m%d).log"
mkdir -p "$HOME/.update-logs"

log() {
    echo "[$(date +'%Y-%m-%d %H:%M:%S')] $1" | tee -a "$LOG_FILE"
}

log "ðŸ”’ INICIANDO ATUALIZAÃ‡ÃƒO DE SEGURANÃ‡A"
log "========================================="

# 1. HOMEBREW (CRÃTICO - inclui certificados SSL)
log ""
log "ðŸ“¦ [1/6] Atualizando Homebrew..."
if brew update >> "$LOG_FILE" 2>&1; then
    OUTDATED=$(brew outdated | wc -l | xargs)
    if [ "$OUTDATED" -gt 0 ]; then
        log "   â†’ $OUTDATED pacotes desatualizados encontrados"
        brew upgrade >> "$LOG_FILE" 2>&1 && log "   âœ… Homebrew atualizado ($OUTDATED pacotes)"
    else
        log "   âœ… Homebrew jÃ¡ estÃ¡ atualizado"
    fi
    brew cleanup -s >> "$LOG_FILE" 2>&1
else
    log "   âŒ Erro ao atualizar Homebrew"
fi

# 2. NPM GLOBAL (GitHub Copilot, Firebase, etc)
log ""
log "ðŸ“¦ [2/6] Atualizando NPM global..."
if npm update -g >> "$LOG_FILE" 2>&1; then
    log "   âœ… NPM global atualizado"
else
    log "   âŒ Erro ao atualizar NPM"
fi

# 3. PYTHON/PIP (ComfyUI e dependÃªncias)
log ""
log "ðŸ“¦ [3/6] Atualizando Python/pip..."
OUTDATED_PIP=$(pip3 list --outdated 2>/dev/null | tail -n +3 | wc -l | xargs)
if [ "$OUTDATED_PIP" -gt 0 ]; then
    log "   â†’ $OUTDATED_PIP pacotes Python desatualizados"
    # Atualiza apenas pacotes crÃ­ticos de seguranÃ§a
    pip3 list --outdated --format=freeze 2>/dev/null | grep -v '^\-e' | cut -d = -f 1 | xargs -n1 pip3 install -U >> "$LOG_FILE" 2>&1 && log "   âœ… Python/pip atualizado ($OUTDATED_PIP pacotes)"
else
    log "   âœ… Python/pip jÃ¡ estÃ¡ atualizado"
fi

# 4. RUBY GEMS (Bundler e dependÃªncias - Homebrew Ruby 3.4)
log ""
log "ðŸ“¦ [4/6] Atualizando Ruby gems..."
export PATH="/opt/homebrew/opt/ruby/bin:$PATH"
if /opt/homebrew/opt/ruby/bin/gem update --system >> "$LOG_FILE" 2>&1 && /opt/homebrew/opt/ruby/bin/gem update >> "$LOG_FILE" 2>&1; then
    log "   âœ… Ruby gems atualizados (Homebrew Ruby 3.4)"
else
    log "   âŒ Erro ao atualizar Ruby gems"
fi

# 5. macOS SYSTEM UPDATES (apenas listar, nÃ£o instalar automaticamente)
log ""
log "ðŸ“¦ [5/6] Verificando atualizaÃ§Ãµes do macOS..."
MACOS_UPDATES=$(softwareupdate --list 2>&1 | grep "recommended" | wc -l | xargs)
if [ "${MACOS_UPDATES:-0}" -gt 0 ]; then
    log "   âš ï¸  $MACOS_UPDATES atualizaÃ§Ãµes do macOS disponÃ­veis"
    log "   â†’ Execute: softwareupdate --install --recommended"
else
    log "   âœ… macOS estÃ¡ atualizado"
fi

# 6. LIMPAR CACHES DE SEGURANÃ‡A
log ""
log "ðŸ“¦ [6/6] Limpando caches..."
npm cache clean --force >> "$LOG_FILE" 2>&1
brew cleanup -s >> "$LOG_FILE" 2>&1
log "   âœ… Caches limpos"

# RESUMO FINAL
log ""
log "========================================="
log "âœ… ATUALIZAÃ‡ÃƒO DE SEGURANÃ‡A CONCLUÃDA"
log "ðŸ“Š Log salvo em: $LOG_FILE"

# Limpar logs antigos (>30 dias)
find "$HOME/.update-logs" -name "security-update-*.log" -mtime +30 -delete 2>/dev/null

# Exibir resumo no terminal (se executado manualmente)
if [ -t 1 ]; then
    echo ""
    echo "âœ… AtualizaÃ§Ã£o concluÃ­da! Resumo:"
    echo "   - Homebrew: $(brew outdated | wc -l | xargs) pacotes ainda desatualizados"
    echo "   - NPM: $(npm outdated -g --depth=0 2>/dev/null | tail -n +2 | wc -l | xargs) pacotes ainda desatualizados"
    echo "   - Python: $(pip3 list --outdated 2>/dev/null | tail -n +3 | wc -l | xargs) pacotes ainda desatualizados"
    echo "   - Log: $LOG_FILE"
fi
